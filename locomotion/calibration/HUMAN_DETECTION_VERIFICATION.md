# 人間検出システム検証手順書

**対象**: locomotion/calibration モジュール - 人間検出システム  
**対象カメラ**: Intel RealSense D415  
**対象プラットフォーム**: Apple Silicon macOS (M1/M2/M3), Linux  
**最終更新**: 2025-11-09

---

## 1. 概要

このドキュメントでは、人間検出システム（HumanDetector）とモニターUI（monitor_human_detection）の検証方法を説明します。

### 1.1 検証対象

- **HumanDetector**: 深度画像ベースの人間検出とトラッキング
- **HumanDetectionConverter**: MotionPlannerへの変換
- **monitor_human_detection**: リアルタイムモニターUI

### 1.2 前提条件

- キャリブレーションが完了していること（`calibration_result.json`が存在）
- RealSense D415カメラが接続されていること
- カメラがtoioプレイマットの真上約2600mmに設置されていること

---

## 2. ビルドと準備

### 2.1 ビルド

```bash
cd /Users/ksk432/technetope/locomotion/calibration

# ビルドディレクトリの作成
cmake -B build

# ビルド実行
cmake --build build

# ビルド結果の確認
ls -la build/monitor_human_detection
```

### 2.2 設定ファイルの確認

```bash
# 人間検出設定ファイルの確認
cat config/human_detection_monitor.json

# キャリブレーション結果の確認
cat calibration_result.json | jq '.toio_coordinate_transform'
```

---

## 3. モニターUIの基本動作確認

### 3.1 起動と表示確認

```bash
# カメラプロセスの停止（macOSの場合）
sudo killall VDCAssistant AppleCameraAssistant 2>/dev/null || true

# モニターUIの起動
sudo ./build/monitor_human_detection calibration_result.json [config/human_detection_monitor.json]
```

**確認項目:**

- [ ] ウィンドウが3つのパネルで開く
  - パネル1（左）: 生のカラー画像
  - パネル2（中央）: 人間検出結果のオーバーレイ
  - パネル3（右）: toio座標上の可視化
- [ ] ステータス情報が表示される（左上）
  - Status: DETECTING/PAUSED
  - FPS
  - Humans: 検出人数
  - Processing: 処理時間（ms）
- [ ] 操作説明が表示される（右下）
  - CONTROLS: [SPACE] Start/Stop [R] Reset [Q/ESC] Quit

### 3.2 キーボード制御の確認

**操作手順:**

1. **スタート/ストップ**: `SPACE`キーを押して検出を一時停止/再開
   - [ ] ステータスが "PAUSED" / "DETECTING" に切り替わる
   - [ ] 検出が停止/再開される

2. **リセット**: `R`キーを押してトラッキング状態をリセット
   - [ ] トラッキングIDがリセットされる
   - [ ] 検出結果がクリアされる

3. **終了**: `Q`または`ESC`キーで終了
   - [ ] ウィンドウが閉じる
   - [ ] プログラムが正常終了する

---

## 4. 人間検出の動作確認

### 4.1 単一人物の検出（静止状態）

**テスト手順:**

1. 1人がtoioプレイマット上に立つ
2. 静止状態を維持（5-10秒）
3. モニターUIで以下を確認:

**確認項目:**

- [ ] パネル2（検出結果）に以下が表示される:
  - 頭位置（緑の円、半径5px）
  - 足位置（青の円、半径8px）
  - 楕円領域（黄色の楕円）
  - トラッキングID（テキスト）
  - 動き状態: "STANDING"（緑色）
  - 信頼度（%）
- [ ] パネル3（toio座標）に以下が表示される:
  - 人間の位置（緑色の円、STANDING状態）
  - トラッキングID
  - 速度ベクトル（ほとんど表示されない、または非常に小さい）
- [ ] ステータスに "Humans: 1" が表示される
- [ ] 処理時間が < 50ms である

### 4.2 単一人物の検出（移動状態）

**テスト手順:**

1. 1人がtoioプレイマット上を歩く
2. モニターUIで以下を確認:

**確認項目:**

- [ ] パネル2に動き状態: "MOVING"（赤色）が表示される
- [ ] パネル3に人間の位置（赤色の円、MOVING状態）が表示される
- [ ] 速度ベクトル（矢印）が表示される
- [ ] トラッキングIDが維持される（人物が移動してもIDが変わらない）
- [ ] 位置が滑らかに更新される（ノイズが少ない）

### 4.3 複数人物の検出

**テスト手順:**

1. 2-3人がtoioプレイマット上に立つ/歩く
2. モニターUIで以下を確認:

**確認項目:**

- [ ] 複数の人間が検出される（最大10人まで）
- [ ] 各人間に異なるトラッキングIDが割り当てられる
- [ ] 各人間の位置が独立して表示される
- [ ] 人物が接近してもIDが混同されない
- [ ] 処理時間が許容範囲内（< 100ms for 3人）

### 4.4 トラッキングの継続性

**テスト手順:**

1. 1人がtoioプレイマット上を歩く
2. 一時的に検出が不安定になる（手で顔を隠すなど）
3. モニターUIで以下を確認:

**確認項目:**

- [ ] 検出が不安定でもトラッキングIDが維持される
- [ ] フォールバック処理（頭から足の推定）が動作する
- [ ] 位置の平滑化により、ノイズが低減されている
- [ ] 検出が復帰すると、正確な位置に戻る

---

## 5. 座標変換の精度確認

### 5.1 toio座標の表示確認

**テスト手順:**

1. 1人がtoioプレイマット上の既知の位置（例: 中央）に立つ
2. モニターUIで以下を確認:

**確認項目:**

- [ ] パネル3（toio座標）に人間の位置が表示される
- [ ] 表示位置がプレイマットの範囲内である
- [ ] 座標範囲が正しく表示される（左下のラベル）
- [ ] グリッドが表示される（オプション）

### 5.2 座標変換の精度テスト

**テスト手順:**

1. toioプレイマット上の複数の既知位置にマーカーを配置
2. 各位置に人が立つ
3. モニターUIでtoio座標を記録
4. 既知位置と比較

**期待される結果:**

- [ ] toio座標の誤差が ≤ 5 ID units（≈ 3.5mm）である
- [ ] 複数位置で一貫した精度が得られる

---

## 6. 速度計算と動き判定の検証

### 6.1 静止状態の判定

**テスト手順:**

1. 1人がtoioプレイマット上に立つ
2. 10秒間静止状態を維持
3. モニターUIで以下を確認:

**確認項目:**

- [ ] 動き状態が "STANDING" になる
- [ ] 速度ベクトルが非常に小さい（< 50mm/s）
- [ ] ノイズによる誤判定が少ない
- [ ] 位置の変動が小さい（平滑化が機能している）

### 6.2 移動状態の判定

**テスト手順:**

1. 1人がtoioプレイマット上を歩く
2. モニターUIで以下を確認:

**確認項目:**

- [ ] 動き状態が "MOVING" になる
- [ ] 速度ベクトルが表示される
- [ ] 速度の方向が移動方向と一致する
- [ ] 速度の大きさが合理的（100-500mm/s程度）

### 6.3 時間重み付き速度計算の検証

**テスト手順:**

1. 1人がtoioプレイマット上を歩く
2. 突然停止する
3. モニターUIで以下を確認:

**確認項目:**

- [ ] 停止後、速度が徐々に減少する（時間重み付き平均の効果）
- [ ] 静止判定までに適切な時間（0.5-1秒）がかかる
- [ ] ノイズによる誤判定が少ない

---

## 7. ノイズ対策の検証

### 7.1 外れ値除去の検証

**テスト手順:**

1. 1人がtoioプレイマット上に立つ
2. 検出が一時的に不安定になる（手を振るなど）
3. モニターUIで以下を確認:

**確認項目:**

- [ ] 異常な位置の変動が無視される
- [ ] 位置が滑らかに更新される
- [ ] トラッキングIDが維持される

### 7.2 位置の平滑化の検証

**テスト手順:**

1. 1人がtoioプレイマット上に立つ
2. 小さな動き（揺れなど）をする
3. モニターUIで以下を確認:

**確認項目:**

- [ ] 位置の変動が平滑化される
- [ ] ノイズによる位置の急変が少ない
- [ ] 静止状態の判定が安定している

---

## 8. パフォーマンステスト

### 8.1 処理時間の測定

**テスト手順:**

```bash
# モニターUIを起動し、処理時間を確認
sudo ./build/monitor_human_detection calibration_result.json
```

**確認項目:**

- [ ] 処理時間が < 50ms/フレームである
- [ ] FPSが ≥ 15 FPSである
- [ ] 複数人の検出でも処理時間が許容範囲内である

### 8.2 メモリ使用量の確認

**テスト手順:**

```bash
# プロセスのメモリ使用量を監視
sudo ./build/monitor_human_detection calibration_result.json &
PID=$!
sleep 10
ps aux | grep monitor_human_detection
kill $PID
```

**確認項目:**

- [ ] メモリ使用量が安定している（リークがない）
- [ ] 長時間実行してもメモリ使用量が増加しない

---

## 9. エッジケースの検証

### 9.1 検出失敗時の動作

**テスト手順:**

1. カメラを一時的に覆う
2. モニターUIで以下を確認:

**確認項目:**

- [ ] エラーメッセージが表示される
- [ ] プログラムがクラッシュしない
- [ ] カメラが復帰すると検出が再開される

### 9.2 複数人の接近・分離

**テスト手順:**

1. 2人がtoioプレイマット上に立つ
2. 接近してから分離する
3. モニターUIで以下を確認:

**確認項目:**

- [ ] 接近時もIDが維持される
- [ ] 分離後もIDが正しく維持される
- [ ] IDの混同が発生しない

### 9.3 長時間実行の安定性

**テスト手順:**

1. モニターUIを10分間実行
2. 以下を確認:

**確認項目:**

- [ ] メモリリークがない
- [ ] 処理時間が安定している
- [ ] トラッキングが継続的に動作する

---

## 10. MotionPlanner統合の検証

### 10.1 DynamicObstacle変換の確認

**テスト手順:**

```cpp
// サンプルコード（統合テスト用）
#include "locomotion/calibration/HumanDetector.h"
#include "locomotion/calibration/HumanDetectionConverter.h"

// 人間検出の実行
HumanDetectionResult result = detector.Detect(frame, snapshot);

// MotionPlannerへの変換
std::vector<locomotion::robot::DynamicObstacle> obstacles =
    ConvertToDynamicObstacles(result, 0.8f, 5);

// 変換結果の確認
assert(!obstacles.empty());
assert(obstacles[0].samples.size() == 5);
```

**確認項目:**

- [ ] `ConvertToDynamicObstacles`が正常に動作する
- [ ] 変換された`DynamicObstacle`が正しい形式である
- [ ] 未来位置の予測が含まれている
- [ ] 確信度が適切に設定されている

### 10.2 速度予測の検証

**テスト手順:**

1. 1人がtoioプレイマット上を歩く
2. MotionPlannerに変換された障害物の未来位置を確認

**確認項目:**

- [ ] 未来位置が速度に基づいて計算されている
- [ ] 予測期間（0.8秒）内で位置が更新される
- [ ] 確信度が時間とともに減少する
- [ ] 移動中の確信度が高い

---

## 11. 検証チェックリスト

### 11.1 基本機能

- [ ] モニターUIが正常に起動する
- [ ] 3つのパネルが表示される
- [ ] キーボード制御が動作する
- [ ] キャリブレーション結果が正しく読み込まれる

### 11.2 人間検出

- [ ] 単一人物が検出される
- [ ] 複数人物が検出される（最大10人）
- [ ] 頭と足の位置が検出される
- [ ] 楕円領域が推定される
- [ ] トラッキングIDが割り当てられる

### 11.3 座標変換

- [ ] toio座標への変換が動作する
- [ ] 座標の精度が ≤ 5 ID unitsである
- [ ] 座標範囲が正しく表示される

### 11.4 動き判定

- [ ] 静止状態（STANDING）が正しく判定される
- [ ] 移動状態（MOVING）が正しく判定される
- [ ] 速度計算が正確である
- [ ] 時間重み付き速度計算が動作する

### 11.5 ノイズ対策

- [ ] 外れ値除去が動作する
- [ ] 位置の平滑化が動作する
- [ ] ノイズによる誤判定が少ない

### 11.6 トラッキング

- [ ] トラッキングIDが維持される
- [ ] 複数人のIDが混同されない
- [ ] トラッキングタイムアウトが動作する
- [ ] リセット機能が動作する

### 11.7 パフォーマンス

- [ ] 処理時間が < 50ms/フレームである
- [ ] FPSが ≥ 15 FPSである
- [ ] メモリリークがない
- [ ] 長時間実行が安定している

### 11.8 MotionPlanner統合

- [ ] `ConvertToDynamicObstacles`が動作する
- [ ] 未来位置の予測が含まれている
- [ ] 確信度が適切に設定されている

---

## 12. トラブルシューティング

### 12.1 人間が検出されない

**原因と対策:**

- **深度範囲の設定**: `min_depth_mm`と`max_depth_mm`を確認
- **カメラの高さ**: 約2600mmが推奨
- **照明条件**: 暗い環境では深度センサーの精度が低下
- **設定ファイル**: `config/human_detection_monitor.json`を確認

### 12.2 検出精度が低い

**原因と対策:**

- **モルフォロジー処理**: `morphology_kernel_size`と`morphology_iterations`を調整
- **サイズフィルタ**: `min_person_height_mm`と`max_person_height_mm`を調整
- **Coarse-to-fine**: `enable_coarse_to_fine`が有効であることを確認

### 12.3 処理時間が長い

**原因と対策:**

- **フレームスキップ**: `skip_frames`を増やす
- **Coarse-to-fine**: `coarse_scale_factor`を増やす
- **履歴フレーム数**: `movement_history_frames`を減らす（精度は低下）

### 12.4 トラッキングが不安定

**原因と対策:**

- **トラッキング距離**: `tracking_max_distance_mm`を調整
- **ノイズ対策**: `noise_threshold_mm`と`outlier_threshold_std`を調整
- **位置の平滑化**: `position_smoothing_alpha`を調整

### 12.5 座標変換が不正確

**原因と対策:**

- **キャリブレーション結果**: キャリブレーションを再実行
- **toio座標範囲**: `coverage_area`が正しく設定されているか確認
- **ホモグラフィ**: `homography_color_to_toio`が正しく読み込まれているか確認

---

## 13. パフォーマンス基準

### 13.1 処理時間

- **目標**: < 50ms/フレーム
- **許容**: < 100ms/フレーム（複数人の場合）

### 13.2 フレームレート

- **目標**: ≥ 15 FPS
- **許容**: ≥ 10 FPS

### 13.3 検出精度

- **位置精度**: ≤ 5 ID units（≈ 3.5mm）
- **トラッキング精度**: ID混同率 < 5%

### 13.4 メモリ使用量

- **目標**: < 100MB
- **許容**: < 200MB

---

## 14. 参考文献

- [HUMAN_DETECTION_USAGE.md](HUMAN_DETECTION_USAGE.md) - 使用方法
- [HUMAN_DETECTION_COMPUTATION.md](HUMAN_DETECTION_COMPUTATION.md) - 計算方法
- [VELOCITY_COMPUTATION_IMPROVEMENTS.md](VELOCITY_COMPUTATION_IMPROVEMENTS.md) - 速度計算の改善
- [TESTING.md](TESTING.md) - キャリブレーションシステムのテスト手順

---

## 15. 更新履歴

- 2025-11-09: 初版作成

